<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bull & Piano - Dynamic NFT</title>
    <link rel="preconnect" href="https://arweave.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                borderRadius: {
                    lg: "var(--radius)",
                    md: "calc(var(--radius) - 2px)",
                    sm: "calc(var(--radius) - 4px)",
                },
                colors: {
                    background: "var(--background)",
                    foreground: "var(--foreground)",
                    card: {
                        DEFAULT: "var(--card)",
                        foreground: "var(--card-foreground)",
                    },
                    primary: {
                        DEFAULT: "var(--primary)",
                        foreground: "var(--primary-foreground)",
                    },
                    secondary: {
                        DEFAULT: "var(--secondary)",
                        foreground: "var(--secondary-foreground)",
                    },
                    muted: {
                        DEFAULT: "var(--muted)",
                        foreground: "var(--muted-foreground)",
                    },
                    accent: {
                        DEFAULT: "var(--accent)",
                        foreground: "var(--accent-foreground)",
                    },
                    border: "var(--border)",
                    ring: "var(--ring)",
                },
                fontFamily: {
                    sans: ["Inter", "sans-serif"],
                    mono: ["JetBrains Mono", "monospace"],
                }
            },
        }
    };
    </script>
    <style>
        :root {
            --background: hsl(240, 6%, 4%);
            --foreground: hsl(0, 0%, 98%);
            --card: hsl(240, 4%, 8%);
            --card-foreground: hsl(0, 0%, 95%);
            --primary: hsl(195, 100%, 50%);
            --primary-foreground: hsl(240, 6%, 4%);
            --secondary: hsl(240, 4%, 16%);
            --secondary-foreground: hsl(0, 0%, 90%);
            --muted: hsl(240, 4%, 12%);
            --muted-foreground: hsl(240, 4%, 65%);
            --accent: hsl(195, 100%, 50%);
            --accent-foreground: hsl(240, 6%, 4%);
            --border: hsl(240, 4%, 16%);
            --ring: hsl(195, 100%, 50%);
            --radius: 0.75rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--foreground);
        }

        .nft-container {
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }

        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 210, 255, 0.3); }
            50% { box-shadow: 0 0 30px rgba(0, 210, 255, 0.6); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .state-indicator {
            position: relative;
            overflow: hidden;
        }

        .state-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 210, 255, 0.3), transparent);
            transition: left 0.8s;
        }

        .state-indicator.active::before {
            left: 100%;
        }

        .gradient-text {
            background: linear-gradient(135deg, hsl(195, 100%, 50%), hsl(195, 100%, 70%));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-background text-foreground min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-12 fade-in">
            <h1 class="text-4xl md:text-6xl font-bold mb-4 gradient-text">Bull & Piano</h1>
            <p class="text-muted-foreground text-lg md:text-xl max-w-2xl mx-auto">
                A dynamic NFT that reflects market sentiment through artistic expression
            </p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- Market Data Panel -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Current State Card -->
                <div class="bg-card border border-border rounded-lg p-6 state-indicator" id="stateCard">
                    <div class="text-center">
                        <div class="text-sm text-muted-foreground uppercase tracking-wide mb-2">Current State</div>
                        <div class="text-2xl font-bold mb-2 capitalize gradient-text" id="currentState">stagnation</div>
                        <div class="w-full bg-secondary h-2 rounded-full overflow-hidden">
                            <div class="bg-primary h-full transition-all duration-1000" id="healthBar" style="width: 45%"></div>
                        </div>
                        <div class="text-xs text-muted-foreground mt-2">Market Health</div>
                    </div>
                </div>

                <!-- Volume Metrics -->
                <div class="bg-card border border-border rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <div class="w-2 h-2 bg-primary rounded-full mr-3"></div>
                        Volume Metrics
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-muted-foreground">24h Volume</span>
                            <span class="font-mono font-medium" id="volume24h">--</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-muted-foreground">7d Avg/Day</span>
                            <span class="font-mono font-medium" id="volume30dAvg">--</span>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-border">
                            <span class="text-muted-foreground">Sentiment Score</span>
                            <span class="font-mono font-medium text-primary" id="volumeRatio">--</span>
                        </div>
                    </div>
                </div>

                <!-- Status Panel -->
                <div class="bg-card border border-border rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <div class="w-2 h-2 bg-accent rounded-full mr-3"></div>
                        Status
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-muted-foreground text-sm">Data Source</span>
                            <span class="text-xs bg-secondary px-2 py-1 rounded">OpenSea API</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-muted-foreground text-sm">Last Update</span>
                            <span class="text-xs text-muted-foreground" id="lastUpdate">Loading...</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-muted-foreground text-sm">Cache Status</span>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2" id="cacheIndicator"></div>
                                <span class="text-xs text-muted-foreground" id="cacheStatus">Active</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NFT Display -->
            <div class="lg:col-span-6">
                <div class="relative bg-card border border-border rounded-xl p-8 nft-container pulse-glow">
                    <!-- Loading State -->
                    <div id="loadingState" class="absolute inset-0 flex items-center justify-center bg-card rounded-xl">
                        <div class="text-center">
                            <div class="loading-spinner w-8 h-8 border-2 border-primary border-t-transparent rounded-full mx-auto mb-4"></div>
                            <p class="text-muted-foreground">Analyzing market sentiment...</p>
                        </div>
                    </div>

                    <!-- NFT Images Container -->
                    <div class="relative aspect-square w-full max-w-md mx-auto" id="nftContainer">
                        <img 
                            id="capitulation" 
                            src="https://6txiabgkdvd5nenuupzxtp7lbxcvx4vw3kra4ly7blafm2mproda.arweave.net/9O6ABModR9aRtKPzeb_rDcVb8rbaog4vHwrAVmmPi4Y" 
                            alt="Capitulation - Bull skeleton at base of piano" 
                            class="absolute inset-0 w-full h-full object-cover rounded-lg transition-opacity duration-800 opacity-0"
                        />
                        
                        <img 
                            id="stagnation" 
                            src="https://r4vsc7esu3z27xxgh2bqrocs3jz4pin44ahw4hwk3ilabk2o2vwq.arweave.net/jyshfJKm86_e5j6DCLhS2nPHobzgD24eytoWAKtO1W0" 
                            alt="Stagnation - Bull lying at base of piano" 
                            class="absolute inset-0 w-full h-full object-cover rounded-lg transition-opacity duration-800 opacity-100"
                        />
                        
                        <img 
                            id="resilience" 
                            src="https://lgwaa4z6aegrwftnh3v2zdaxjgvvxyv5g7orzbzufbpc5hgqnm5q.arweave.net/WawAcz4BDRsWbT7rrIwXSatb4r033RyHNCheLpzQazs" 
                            alt="Resilience - Bull standing beside piano" 
                            class="absolute inset-0 w-full h-full object-cover rounded-lg transition-opacity duration-800 opacity-0"
                        />
                        
                        <img 
                            id="euphoria" 
                            src="https://tkf3ssqdvpe3bnk25od6twbu3rioxksaxmedvldcs3nbs4ickpoq.arweave.net/mou5SgOrybC1WuuH6dg03FDrqkC7CDqsYpbaGXECU90" 
                            alt="Euphoria - Horde of bulls with piano lifted" 
                            class="absolute inset-0 w-full h-full object-cover rounded-lg transition-opacity duration-800 opacity-0"
                        />
                    </div>
                </div>
            </div>

            <!-- Market Analysis Panel -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Threshold Guide -->
                <div class="bg-card border border-border rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <div class="w-2 h-2 bg-accent rounded-full mr-3"></div>
                        Market States
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 rounded bg-red-500/10 border border-red-500/20">
                            <span class="text-sm font-medium">Capitulation</span>
                            <span class="text-xs font-mono text-muted-foreground">&lt; 0.30</span>
                        </div>
                        <div class="flex items-center justify-between p-3 rounded bg-yellow-500/10 border border-yellow-500/20">
                            <span class="text-sm font-medium">Stagnation</span>
                            <span class="text-xs font-mono text-muted-foreground">0.30 - 0.90</span>
                        </div>
                        <div class="flex items-center justify-between p-3 rounded bg-blue-500/10 border border-blue-500/20">
                            <span class="text-sm font-medium">Resilience</span>
                            <span class="text-xs font-mono text-muted-foreground">0.90 - 1.50</span>
                        </div>
                        <div class="flex items-center justify-between p-3 rounded bg-green-500/10 border border-green-500/20">
                            <span class="text-sm font-medium">Euphoria</span>
                            <span class="text-xs font-mono text-muted-foreground">&gt;= 1.50</span>
                        </div>
                    </div>
                </div>

                <!-- Collection Info -->
                <div class="bg-card border border-border rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <div class="w-2 h-2 bg-primary rounded-full mr-3"></div>
                        Collection
                    </h3>
                    <div class="space-y-3">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-primary to-accent rounded-full mx-auto mb-3 flex items-center justify-center">
                                <span class="text-xl font-bold text-primary-foreground">B&P</span>
                            </div>
                            <h4 class="font-semibold">Bull & Piano Collection</h4>
                            <p class="text-sm text-muted-foreground">Dynamic market sentiment NFT</p>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="bg-card border border-border rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <div class="w-2 h-2 bg-accent rounded-full mr-3"></div>
                        Controls
                    </h3>
                    <div class="space-y-3">
                        <button 
                            id="refreshBtn" 
                            class="w-full bg-primary text-primary-foreground py-2 px-4 rounded-md hover:bg-primary/90 transition-colors font-medium"
                        >
                            Refresh Data
                        </button>
                        <div class="text-xs text-muted-foreground text-center">
                            Auto-refresh every 12 hours
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-16 pt-8 border-t border-border text-center text-muted-foreground">
            <p class="text-sm">
                Dynamic NFT powered by OpenSea market data â€¢ Updates every 12 hours
            </p>
        </footer>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            PROXY_URL: '/api/stats',
            DEFAULT_VARIANT: 'stagnation',
            CACHE_DURATION: 12 * 60 * 60 * 1000, // 12 hours in milliseconds
            ASSET_URLS: {
                capitulation: 'https://6txiabgkdvd5nenuupzxtp7lbxcvx4vw3kra4ly7blafm2mproda.arweave.net/9O6ABModR9aRtKPzeb_rDcVb8rbaog4vHwrAVmmPi4Y',
                stagnation: 'https://r4vsc7esu3z27xxgh2bqrocs3jz4pin44ahw4hwk3ilabk2o2vwq.arweave.net/jyshfJKm86_e5j6DCLhS2nPHobzgD24eytoWAKtO1W0',
                resilience: 'https://lgwaa4z6aegrwftnh3v2zdaxjgvvxyv5g7orzbzufbpc5hgqnm5q.arweave.net/WawAcz4BDRsWbT7rrIwXSatb4r033RyHNCheLpzQazs',
                euphoria: 'https://tkf3ssqdvpe3bnk25od6twbu3rioxksaxmedvldcs3nbs4ickpoq.arweave.net/mou5SgOrybC1WuuH6dg03FDrqkC7CDqsYpbaGXECU90'
            }
        };

        (function() {
            let currentState = CONFIG.DEFAULT_VARIANT;
            let isLoading = true;
            let volumeData = null;

            // DOM Elements
            const elements = {
                currentState: document.getElementById('currentState'),
                volume24h: document.getElementById('volume24h'),
                volume30dAvg: document.getElementById('volume30dAvg'),
                volumeRatio: document.getElementById('volumeRatio'),
                lastUpdate: document.getElementById('lastUpdate'),
                cacheStatus: document.getElementById('cacheStatus'),
                cacheIndicator: document.getElementById('cacheIndicator'),
                healthBar: document.getElementById('healthBar'),
                loadingState: document.getElementById('loadingState'),
                nftContainer: document.getElementById('nftContainer'),
                refreshBtn: document.getElementById('refreshBtn'),
                stateCard: document.getElementById('stateCard')
            };

            // Utility Functions
            function getUrlParameter(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }

            function formatEth(value) {
                if (value === null || value === undefined || isNaN(value)) return '--';
                return `${parseFloat(value).toFixed(3)} ETH`;
            }

            function calculateRatio(volume1d, volume30d) {
                if (!volume1d || !volume30d || volume30d === 0) return 0;
                const avgPerDay = volume30d / 30;
                return volume1d / avgPerDay;
            }

            function determineState(ratio) {
                if (ratio < 0.30) return 'capitulation';
                if (ratio < 0.90) return 'stagnation';
                if (ratio < 1.50) return 'resilience';
                return 'euphoria';
            }

            function getHealthPercentage(ratio) {
                const maxRatio = 2.0;
                return Math.min((ratio / maxRatio) * 100, 100);
            }

            // Cache Management
            function getCachedData() {
                try {
                    const cached = localStorage.getItem('nft-volume-data');
                    if (!cached) return null;
                    
                    const data = JSON.parse(cached);
                    const now = Date.now();
                    
                    if (now - data.timestamp > CONFIG.CACHE_DURATION) {
                        localStorage.removeItem('nft-volume-data');
                        return null;
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Error reading cache:', error);
                    return null;
                }
            }

            function setCachedData(data) {
                try {
                    const cacheData = {
                        ...data,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('nft-volume-data', JSON.stringify(cacheData));
                } catch (error) {
                    console.error('Error setting cache:', error);
                }
            }

            // API Functions
            async function fetchVolumeData() {
                try {
                    // Get collection slug from environment or use default
                    const slug = window.COLLECTION_SLUG || 'boredapeyachtclub';
                    const response = await fetch(`${CONFIG.PROXY_URL}?slug=${slug}`, {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: response.statusText }));
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching volume data:', error);
                    throw error;
                }
            }

            // UI Update Functions
            function updateUI(state, data = null) {
                elements.currentState.textContent = state;
                currentState = state;

                showNFTState(state);

                if (data) {
                    volumeData = data;
                    const ratio = calculateRatio(data.volume_1d, data.volume_30d);
                    const avgPerDay = data.volume_30d / 30;

                    elements.volume24h.textContent = formatEth(data.volume_1d);
                    elements.volume30dAvg.textContent = formatEth(avgPerDay);
                    elements.volumeRatio.textContent = ratio.toFixed(2);
                    
                    const healthPercentage = getHealthPercentage(ratio);
                    elements.healthBar.style.width = `${healthPercentage}%`;
                }

                elements.lastUpdate.textContent = new Date().toLocaleTimeString();

                elements.stateCard.classList.add('active');
                setTimeout(() => {
                    elements.stateCard.classList.remove('active');
                }, 800);
            }

            function showNFTState(state) {
                const allImages = elements.nftContainer.querySelectorAll('img');
                allImages.forEach(img => {
                    img.style.opacity = '0';
                });

                const activeImage = document.getElementById(state);
                if (activeImage) {
                    setTimeout(() => {
                        activeImage.style.opacity = '1';
                    }, 200);
                }
            }

            function setLoadingState(loading) {
                isLoading = loading;
                elements.loadingState.style.display = loading ? 'flex' : 'none';
                elements.refreshBtn.disabled = loading;
                elements.refreshBtn.textContent = loading ? 'Loading...' : 'Refresh Data';

                if (loading) {
                    elements.cacheIndicator.className = 'w-2 h-2 bg-yellow-500 rounded-full mr-2';
                    elements.cacheStatus.textContent = 'Updating';
                } else {
                    elements.cacheIndicator.className = 'w-2 h-2 bg-green-500 rounded-full mr-2';
                    elements.cacheStatus.textContent = 'Active';
                }
            }

            function showError(message) {
                elements.lastUpdate.textContent = `Error: ${message}`;
                elements.cacheIndicator.className = 'w-2 h-2 bg-red-500 rounded-full mr-2';
                elements.cacheStatus.textContent = 'Error';
            }

            // Main Logic
            async function initializeNFT() {
                const forceState = getUrlParameter('force');
                if (forceState && ['capitulation', 'stagnation', 'resilience', 'euphoria'].includes(forceState)) {
                    setLoadingState(false);
                    updateUI(forceState);
                    return;
                }

                const cachedData = getCachedData();
                if (cachedData && cachedData.sentiment_data) {
                    setLoadingState(false);
                    updateUI(cachedData.sentiment_data.market_state, cachedData.sentiment_data);
                    return;
                }

                try {
                    setLoadingState(true);
                    const sentimentData = await fetchSentimentData();
                    
                    if (sentimentData && sentimentData.market_state) {
                        setCachedData({ sentiment_data: sentimentData });
                        updateUI(sentimentData.market_state, sentimentData);
                    } else {
                        throw new Error('Invalid sentiment data format received');
                    }
                } catch (error) {
                    console.error('Failed to fetch sentiment data, using default state:', error);
                    showError(error.message);
                    updateUI(CONFIG.DEFAULT_VARIANT);
                } finally {
                    setLoadingState(false);
                }
            }

            // Event Handlers
            function handleRefresh() {
                localStorage.removeItem('nft-sentiment-data');
                initializeNFT();
            }

            function init() {
                elements.refreshBtn.addEventListener('click', handleRefresh);
                initializeNFT();

                setInterval(() => {
                    const cachedData = getCachedData();
                    if (!cachedData) {
                        initializeNFT();
                    }
                }, CONFIG.CACHE_DURATION);
            }

            init();
        })();
    </script>
</body>
</html>
